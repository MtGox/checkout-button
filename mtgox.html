<!DOCTYPE html>  <html> <head>   <title>mtgox.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               mtgox.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This script allows a user to easily embed a <strong>MtGox Dynamic Checkout Button</strong>
on their webpage just by using a special tag and including a Javascript file</p>

<p><strong>Usage:</strong>
Add in the page an element using the following specification:</p>

<pre><code>&lt;span class="mtgox"
  data-id="{transaction_id}" data-amount="{amount}"
  data-currency="{user_currency}"&gt;
  &lt;!-- The following element is optionnal and is only here to
        provide a fallback if the user doesn't use javascript
  --&gt;
  &lt;a href="https://payment.mtgox.com/{transaction_id}"&gt;
    &lt;img src="https://payment.mtgox.com/img/mtgox-checkout.png"&gt;
  &lt;/a&gt;
&lt;/span&gt;
</code></pre>

<p>... then just include our javascript file, all the matching elements will be
automatically replaced</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Global variable declararation</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Contains our generated buttons</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buttons = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Whether socket.io is loaded or not</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">sIoLoaded = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Whether we added the CSS or not</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cssAdded = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>CSS file</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cssURI = </span><span class="s">&quot;https://payment.mtgox.com/css/mtgox.min.css&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>MtGox + BTC logo</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">imgLogo = </span><span class="s">&quot;https://payment.mtgox.com/img/button-logo.png?v3&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Socket.io's host</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">socketIoHost = </span><span class="s">&quot;https://socketio.mtgox.com:443&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Retrieve the right "head" object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">head = </span><span class="nb">document</span><span class="p">.</span><span class="nx">head</span> <span class="o">or</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">or</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>Utility</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>This class provides a set of static methods used mainly to manipulate objects or
the DOM</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Utility</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><em>static</em> <strong>inArray</strong></p>

<p>Check if value X is in array Y</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@inArray: </span><span class="nf">(array, value) -&gt;</span>
		<span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">array</span>
			<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">item</span> <span class="o">==</span> <span class="nx">value</span>
		<span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><em>static</em> <strong>getScript</strong></p>

<p>Utility function to retrieve a script (ported from jQuery 1.7.2) and modified for our needs
We first create the element and attach a cross-browser handler for <strong>onload</strong>, if the handler
is called with success we remove the event handler to prevent a memory leak on IE and
destroy the element completely before calling the callback</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@getScript: </span><span class="nf">(url, callback) -&gt;</span>
		<span class="nv">script = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&quot;script&quot;</span><span class="p">)</span>
		<span class="nv">script.type = </span><span class="s">&quot;text/javascript&quot;</span>
		<span class="nv">script.async = </span><span class="s">&quot;async&quot;</span>
		<span class="nv">script.onload = script.onreadystatechange = </span><span class="nf">(_, isAbort) -&gt;</span>
			<span class="k">if</span> <span class="nx">isAbort</span> <span class="o">or</span> <span class="o">!</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">or</span> <span class="sr">/loaded|complete/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span>
				<span class="nv">script.onload = script.onreadystatechange = </span><span class="kc">null</span>
				<span class="nx">head</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="k">if</span> <span class="nx">head</span> <span class="o">and</span> <span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span>
				<span class="nv">script = </span><span class="kc">undefined</span>
				<span class="nx">callback</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="o">!</span><span class="nx">isAbort</span>
		<span class="nv">script.src = </span><span class="nx">url</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Use insertBefore instead of appendChild to circumvent an IE6 bug</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">head</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">head</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><em>static</em> <strong>getElementsByClassName</strong></p>

<p>Cross-browser implementation of getElementsByClassName, using a fallback on the native
implementation if possible, then on querySelectorAll and finally on manually reading each
element for older browsers, this function was taken and modified from the now defunct
SwellJS library from Jonathan Gautheron <a href="m&#97;&#x69;&#108;&#116;&#x6F;:&#106;&#x67;&#97;&#117;&#x74;&#x68;&#x65;&#x72;&#x6F;&#110;&#x40;&#x74;&#x65;n&#x77;&#x61;&#46;&#x70;&#x6C;">&#106;&#x67;&#97;&#117;&#x74;&#x68;&#x65;&#x72;&#x6F;&#110;&#x40;&#x74;&#x65;n&#x77;&#x61;&#46;&#x70;&#x6C;</a> (https://github.com/jgautheron)
and Christophe Ebl√©</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@getElementsByClassName: </span><span class="nf">(className, root = document.body, tagName = &#39;&#39;) -&gt;</span>
		<span class="k">return</span> <span class="nx">root</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span>

		<span class="k">if</span> <span class="nx">root</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="o">?</span>
			<span class="nv">tagName = </span><span class="nx">tagName</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">root</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">tagName</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">className</span><span class="p">);</span>

		<span class="nv">tagName = </span><span class="nx">tagName</span> <span class="o">or</span> <span class="s">&#39;*&#39;</span>
		<span class="nv">tags = </span><span class="nx">root</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">tagName</span><span class="p">)</span>
		<span class="nv">nodeList = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">tag</span> <span class="k">in</span> <span class="nx">tags</span>
			<span class="nv">classes = </span><span class="p">(</span><span class="k">new</span> <span class="nx">MtGoxElement</span><span class="p">(</span><span class="nx">tag</span><span class="p">)).</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span>
			<span class="nx">nodeList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="k">if</span> <span class="nx">classes</span><span class="o">?</span> <span class="o">and</span> <span class="nx">Utility</span><span class="p">.</span><span class="nx">inArray</span><span class="p">(</span><span class="nx">classes</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">),</span> <span class="nx">className</span><span class="p">)</span>

		<span class="k">return</span> <span class="nx">nodeList</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>MtGoxElement</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Provides a wrapper around HTML elements and augment them with useful cross-browser methods,
also allows easy creation of new elements</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">MtGoxElement</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><strong>Constructor</strong></p>

<p>Just store the native DOM element</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">constructor: </span><span class="nf">(@element) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><strong>hasAttribute</strong></p>

<p>Check if the element as the attribute <em>attr</em> first by trying to call the native <strong>hasAttribute</strong> method
if it exists, or fallback to <em>object.attr</em>, return false on failure</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">hasAttribute: </span><span class="nf">(attr) -&gt;</span>
		<span class="k">if</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="o">?</span>
			<span class="k">return</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">@element</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span><span class="o">?</span>
		<span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><strong>getAttribute</strong></p>

<p>Retrieve the value of the attribute <em>attr</em>, it first check if the attribute is named "class" and in that
case retrieve the <em>object.className</em> attribute instead (IE fix). It then try to use the native <strong>getAttribute</strong>
implementation and finally fallback on <em>object.attr</em></p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">getAttribute: </span><span class="nf">(attr) -&gt;</span>
		<span class="k">return</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">className</span> <span class="k">if</span> <span class="nx">attr</span> <span class="o">==</span> <span class="s">&#39;class&#39;</span> <span class="o">and</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">className</span><span class="o">?</span>
		<span class="k">if</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="o">?</span>
			<span class="k">return</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="nx">@element</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@element</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span><span class="o">?</span>
		<span class="k">return</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p><strong>setAttribute</strong></p>

<p>Set the value of the attribute <em>attr</em> to <em>value</em>, it first check if the attribute is named "class" and in that
case set the <em>object.className</em> attribute instead (IE fix). It then try to use the native <strong>setAttribute</strong>
implementation and finally fallback on setting <em>object.attr</em></p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">setAttribute: </span><span class="nf">(attr, value) -&gt;</span>
		<span class="vi">@element.className = </span><span class="nx">value</span> <span class="k">if</span> <span class="nx">attr</span> <span class="o">==</span> <span class="s">&#39;class&#39;</span>
		<span class="k">if</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">setAttribute</span><span class="o">?</span>
			<span class="k">return</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
		<span class="k">else</span>
			<span class="nx">@element</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
		<span class="k">return</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><strong>appendChild</strong></p>

<p>Append a child on the element</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">appendChild: </span><span class="nf">(elem) -&gt;</span>
		<span class="k">return</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">get</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><strong>clean</strong></p>

<p>Iterate on every childs and remove it</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">clean: </span><span class="nf">() -&gt;</span>
		<span class="k">while</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span>
			<span class="nx">@element</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">@element</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><strong>get</strong></p>

<p>Retrieve the native element</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get: </span><span class="nf">() -&gt;</span>
		<span class="k">return</span> <span class="nx">@element</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><strong>setContent</strong></p>

<p>Set the content of the element. For some unknown reason <em>innerText</em> didn't work on Firefox 11 so we
had to fallback on innerHTML</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">setContent: </span><span class="nf">(text) -&gt;</span>
		<span class="vi">@element.innerHTML = </span><span class="nx">text</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><em>static</em> <strong>create</strong></p>

<p>Create a new element, set the attributes and optionally add it to the parent. The <em>name</em> attribute can be
written in the form tagName.className</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@create: </span><span class="nf">(name, attributes, parent) -&gt;</span>
		<span class="nv">attributes = </span><span class="p">{}</span> <span class="k">if</span> <span class="o">!</span><span class="nx">attributes</span><span class="o">?</span>

		<span class="k">if</span> <span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s">&quot;.&quot;</span>
			<span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">classes</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
			<span class="nx">attributes</span><span class="p">[</span><span class="s">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">classes</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>

		<span class="nv">elem = </span><span class="k">new</span> <span class="nx">MtGoxElement</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
		<span class="nx">elem</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="k">for</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">attributes</span>

		<span class="k">if</span> <span class="nx">parent</span><span class="o">?</span>
			<span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">elem</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>MtGoxSocket</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Encapsulate the Socket.IO functionnality</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">MtGoxSocket</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><em>static</em> <strong>parseSIOMessage</strong></p>

<p>Parse a packet from Socket.IO and redirect it to the correct handler</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@parseSIOMessage: </span><span class="nf">(data) -&gt;</span>
		<span class="k">switch</span> <span class="nx">data</span><span class="p">.</span><span class="nx">op</span>
			<span class="k">when</span> <span class="s">&quot;private&quot;</span> <span class="k">then</span> <span class="nx">MtGoxSocket</span><span class="p">.</span><span class="nx">parseSIOPrivate</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">private</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">private</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><em>static</em> <strong>parseSIOPrivate</strong></p>

<p>Parse a <em>private</em> packet and redirect to handler</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@parseSIOPrivate: </span><span class="nf">(type, data) -&gt;</span>
		<span class="k">switch</span> <span class="nx">type</span>
			<span class="k">when</span> <span class="s">&quot;ticker&quot;</span> <span class="k">then</span> <span class="nx">MtGoxSocket</span><span class="p">.</span><span class="nx">updateButtons</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">last_all</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p><em>static</em> <strong>updateButtons</strong></p>

<p>Get all the buttons on the page and update their current value based on the current ticker value</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@updateButtons: </span><span class="nf">(btc_value) -&gt;</span>
		<span class="k">for</span> <span class="nx">button</span> <span class="k">in</span> <span class="nx">buttons</span>
			<span class="nv">btc_val = </span><span class="nx">button</span><span class="p">.</span><span class="nx">btc_element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;data-amount&#39;</span><span class="p">)</span>
			<span class="nv">cur_val = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">btc_val</span> <span class="o">*</span> <span class="nx">btc_value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
			<span class="nx">button</span><span class="p">.</span><span class="nx">cur_element</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="s">&#39;US$ &#39;</span> <span class="o">+</span> <span class="nx">cur_val</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p><em>static</em> <strong>registerButtonUpdate</strong></p>

<p>Called when Socket.IO is successfully embeded on the page and start listening for ticker events</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@registerButtonUpdate: </span><span class="nf">() -&gt;</span>
		<span class="k">if</span> <span class="nb">window</span><span class="p">.</span><span class="nx">io</span>
			<span class="nv">io = </span><span class="nb">window</span><span class="p">.</span><span class="nx">io</span>
			<span class="nv">socket = </span><span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">socketIoHost</span> <span class="o">+</span> <span class="s">&quot;/mtgox?Currency=USD&amp;Channel=ticker&quot;</span><span class="p">)</span>
			<span class="nx">socket</span><span class="p">.</span><span class="kc">on</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="nx">MtGoxSocket</span><span class="p">.</span><span class="nx">parseSIOMessage</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h3>registerButton</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Our main method, takes a DOM element and create a checkout button inside.
It first checks for socket.io to be loaded and insert our CSS file into the page's header,
then we create the button using the following Jade Template:</p>

<pre><code> a.mtgox-button
  div.mtgox-button-amount
    span.mtgox-button-btc(data-rel="428.50") 428.50 BTC
    br
    span.mtgox-button-cur US$ 2113.80
    span.mtgox-button-logo
      img(src="https://payment.mtgox.com/img/button-logo.png", width="88", height="33")
</code></pre>

<p>Finally we empty the target element and append our button inside</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">registerButton = </span><span class="nf">(element) -&gt;</span>
	<span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">?</span>

	<span class="k">if</span> <span class="o">!</span><span class="nx">sIoLoaded</span>
		<span class="nv">sIoLoaded = </span><span class="kc">true</span>
		<span class="nx">Utility</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span><span class="nx">socketIoHost</span> <span class="o">+</span> <span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="p">,</span> <span class="nx">MtGoxSocket</span><span class="p">.</span><span class="nx">registerButtonUpdate</span><span class="p">)</span>

	<span class="k">if</span> <span class="o">!</span><span class="nx">cssAdded</span>
		<span class="nv">cssAdded = </span><span class="kc">true</span>
		<span class="nv">elem_attr =</span>
			<span class="nv">rel: </span><span class="s">&quot;stylesheet&quot;</span><span class="p">,</span>
			<span class="nv">type: </span><span class="s">&quot;text/css&quot;</span><span class="p">,</span>
			<span class="nv">href: </span><span class="nx">cssURI</span>
		<span class="nv">elem_link = </span><span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;link&quot;</span><span class="p">,</span> <span class="nx">elem_attr</span><span class="p">)</span>
		<span class="nx">head</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">elem_link</span><span class="p">.</span><span class="nx">get</span><span class="p">(),</span> <span class="nx">head</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span>

	<span class="nv">element = </span><span class="k">new</span> <span class="nx">MtGoxElement</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>We need 3 things, the transaction id, the amount and the currency</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">order_info = </span><span class="p">{}</span>
	<span class="k">for</span> <span class="nx">attrName</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;data-id&quot;</span><span class="p">,</span> <span class="s">&quot;data-amount&quot;</span><span class="p">,</span> <span class="s">&quot;data-currency&quot;</span><span class="p">]</span>
		<span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="o">!</span><span class="nx">element</span><span class="p">.</span><span class="nx">hasAttribute</span><span class="p">(</span><span class="nx">attrName</span><span class="p">)</span>
		<span class="nx">order_info</span><span class="p">[</span><span class="nx">attrName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s">&quot;data-&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">attrName</span><span class="p">)</span>

	<span class="nv">payment_url    = </span><span class="s">&quot;https://payment.mtgox.com/&quot;</span> <span class="o">+</span> <span class="nx">order_info</span><span class="p">.</span><span class="nx">id</span>

	<span class="nv">elem_a = </span><span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;a.mtgox-button&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;href&quot;</span><span class="o">:</span> <span class="nx">payment_url</span><span class="p">,</span> <span class="s">&quot;target&quot;</span><span class="o">:</span> <span class="s">&quot;_blank&quot;</span> <span class="p">})</span>

	<span class="nv">elem_amount = </span><span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;div.mtgox-button-amount&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">elem_a</span><span class="p">)</span>

	<span class="nv">btc_text = </span><span class="nx">order_info</span><span class="p">.</span><span class="nx">amount</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nx">order_info</span><span class="p">.</span><span class="nx">currency</span>
	<span class="nv">btc_element = </span><span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;span.mtgox-button-btc&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;data-amount&quot;</span><span class="o">:</span> <span class="nx">order_info</span><span class="p">.</span><span class="nx">amount</span><span class="p">},</span> <span class="nx">elem_amount</span><span class="p">)</span>
	<span class="nx">btc_element</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">btc_text</span><span class="p">)</span>

	<span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;br&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">elem_amount</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Use the BTC amount in the currency element until we get the USD value on the ticker</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">cur_element = </span><span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;span.mtgox-button-cur&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">elem_amount</span><span class="p">)</span>
	<span class="nx">cur_element</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">btc_text</span><span class="p">)</span>

	<span class="nv">elem_img_container = </span><span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;span.mtgox-button-logo&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">elem_amount</span><span class="p">)</span>

	<span class="nv">img_attrs = </span><span class="p">{</span><span class="nv">src: </span><span class="nx">imgLogo</span><span class="p">}</span>
	<span class="nx">MtGoxElement</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s">&quot;img&quot;</span><span class="p">,</span> <span class="nx">img_attrs</span><span class="p">,</span> <span class="nx">elem_img_container</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Finally remove element childs and add button to the DOM</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">element</span><span class="p">.</span><span class="nx">clean</span><span class="p">()</span>
	<span class="nx">element</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem_a</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Register button into our global <em>buttons</em> variable</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">buttons</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nv">element: </span><span class="nx">element</span><span class="p">,</span> <span class="nv">btc_element: </span><span class="nx">btc_element</span><span class="p">,</span> <span class="nv">cur_element: </span><span class="nx">cur_element</span> <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h3>Document onReady handler</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Handler for document "onReady", fire immediately if the document is alread ready
<em>ie.</em> if the script is directly embedded in the DOM or loaded through AJAX</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">readyDone = </span><span class="kc">false</span>
<span class="nv">findButtons = </span><span class="nf">() -&gt;</span>
	<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">readyDone</span> <span class="o">==</span> <span class="kc">true</span>
	<span class="nx">registerButton</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">Utility</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s">&#39;mtgox&#39;</span><span class="p">)</span>
	<span class="nv">readyDone = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Check for the document "readyness" and fire the above handler if necessary</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="s">&quot;complete&quot;</span>
	<span class="nx">findButtons</span><span class="p">()</span>
<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Support every possible onReady listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="o">?</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s">&quot;DOMContentLoaded&quot;</span><span class="p">,</span> <span class="nx">findButtons</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s">&quot;load&quot;</span><span class="p">,</span> <span class="nx">findButtons</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
	<span class="k">else</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s">&quot;onreadystatechange&quot;</span><span class="p">,</span> <span class="nx">findButtons</span><span class="p">)</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s">&quot;onload&quot;</span><span class="p">,</span> <span class="nx">findButtons</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h3>Exports</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>This is our namespace and public methods</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mtgox =</span>
	<span class="nv">button: </span><span class="nx">registerButton</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Export the namespace to the global object</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">MtGox = </span><span class="nx">mtgox</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 